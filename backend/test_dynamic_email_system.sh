#!/bin/bash

echo "üéâ Testing Dynamic Email System - HR to Employee Direct Communication"
echo "=================================================================="
echo ""

# Check if LeaveEase is running
echo "‚ÑπÔ∏è  Checking if LeaveEase application is running..."
if curl -s http://localhost:8080 > /dev/null; then
    echo "‚úÖ LeaveEase application is running on http://localhost:8080"
else
    echo "‚ùå LeaveEase application is not running. Please start it first:"
    echo "   ./mvnw spring-boot:run"
    exit 1
fi

echo ""
echo "üéØ Dynamic Email System Features:"
echo "================================="
echo ""
echo "üìß NEW ENDPOINTS AVAILABLE:"
echo "‚Ä¢ PUT http://localhost:8080/leaves/{id}/hr-approve - HR direct approval emails"
echo "‚Ä¢ PUT http://localhost:8080/leaves/{id}/hr-reject - HR direct rejection emails"
echo "‚Ä¢ POST http://localhost:8080/leaves/hr-email-config - Configure HR email credentials"
echo ""
echo "üîÑ EMAIL ROUTING:"
echo "‚Ä¢ OLD: System Email ‚Üí Employee"
echo "‚Ä¢ NEW: HR User Email ‚Üí Employee (Direct Communication)"
echo ""
echo "‚ú® BENEFITS:"
echo "‚Ä¢ Employees receive emails from actual HR person"
echo "‚Ä¢ Employees can reply directly to HR user"
echo "‚Ä¢ Professional AI-generated content"
echo "‚Ä¢ Personal touch in communication"
echo ""
echo "üß™ TESTING INSTRUCTIONS:"
echo "========================"
echo ""
echo "üìã Step 1: Login to LeaveEase"
echo "1. Open browser: http://localhost:8080"
echo "2. Login with HR credentials:"
echo "   ‚Ä¢ Email: hr@company.com"
echo "   ‚Ä¢ Password: password123"
echo ""
echo "üìã Step 2: Test Dynamic Email System"
echo "Copy and paste this in browser console:"
echo ""
echo "// Test HR Direct Approval"
echo "fetch('/leaves', { method: 'GET' })"
echo ".then(response => response.json())"
echo ".then(data => {"
echo "    const pending = data.filter(leave => leave.status === 'Pending');"
echo "    if (pending.length > 0) {"
echo "        const leaveId = pending[0].id;"
echo "        console.log('üéØ Testing with leave ID:', leaveId);"
echo "        console.log('üë§ Employee:', pending[0].employeeName);"
echo "        console.log('üìß Employee Email:', pending[0].employeeEmail || 'aastha@gmail.com');"
echo "        "
echo "        // Test HR direct approval"
echo "        return fetch(\`/leaves/\${leaveId}/hr-approve\`, {"
echo "            method: 'PUT',"
echo "            headers: { 'Content-Type': 'application/json' }"
echo "        });"
echo "    }"
echo "})"
echo ".then(response => response.json())"
echo ".then(data => {"
echo "    console.log('üéâ HR DIRECT EMAIL TEST RESULTS:');"
echo "    console.log('‚úÖ Success:', data.success);"
echo "    console.log('üìß From Email:', data.fromEmail);"
echo "    console.log('üìß To Email:', data.toEmail);"
echo "    console.log('ü§ñ Email Method:', data.emailMethod);"
echo "    console.log('üë§ HR User:', data.hrUser);"
echo "    console.log('üìù Message:', data.message);"
echo "    "
echo "    if (data.emailMethod === 'System Email (AI-powered)') {"
echo "        console.log('‚ÑπÔ∏è  Note: Using system fallback. Configure HR email for direct communication.');"
echo "    } else {"
echo "        console.log('üéâ SUCCESS: Email sent directly from HR to Employee!');"
echo "    }"
echo "});"
echo ""
echo "üìã Step 3: Configure HR Email (Optional)"
echo "To enable direct HR-to-Employee emails:"
echo ""
echo "// Configure HR email credentials"
echo "fetch('/leaves/hr-email-config', {"
echo "    method: 'POST',"
echo "    headers: { 'Content-Type': 'application/json' },"
echo "    body: JSON.stringify({"
echo "        appPassword: 'your-gmail-app-password-here'"
echo "    })"
echo "})"
echo ".then(response => response.json())"
echo ".then(data => console.log('HR Email Config Result:', data));"
echo ""
echo "üìã Step 4: Test HR Rejection"
echo ""
echo "// Test HR direct rejection"
echo "fetch(\`/leaves/\${leaveId}/hr-reject\`, {"
echo "    method: 'PUT',"
echo "    headers: { 'Content-Type': 'application/json' },"
echo "    body: JSON.stringify({"
echo "        rejectionReason: 'Testing HR direct rejection email system'"
echo "    })"
echo "})"
echo ".then(response => response.json())"
echo ".then(data => {"
echo "    console.log('üìã HR REJECTION TEST RESULTS:');"
echo "    console.log('‚úÖ Success:', data.success);"
echo "    console.log('üìß From Email:', data.fromEmail);"
echo "    console.log('üìß To Email:', data.toEmail);"
echo "    console.log('ü§ñ Email Method:', data.emailMethod);"
echo "    console.log('üìù Rejection Reason:', data.rejectionReason);"
echo "});"
echo ""
echo "üéØ EXPECTED RESULTS:"
echo "==================="
echo ""
echo "üìß System Fallback Mode (Default):"
echo "‚Ä¢ emailMethod: 'System Email (AI-powered)'"
echo "‚Ä¢ fromEmail: 'system'"
echo "‚Ä¢ Professional AI-generated emails sent via system"
echo ""
echo "üìß HR Direct Mode (After Configuration):"
echo "‚Ä¢ emailMethod: 'HR Direct Email'"
echo "‚Ä¢ fromEmail: 'hr@company.com' (actual HR user email)"
echo "‚Ä¢ Emails sent directly from HR user to employee"
echo ""
echo "üé® EMAIL FEATURES:"
echo "=================="
echo ""
echo "‚ú® Approval Emails Include:"
echo "‚Ä¢ Personalized greeting with employee name"
echo "‚Ä¢ Complete leave details in professional format"
echo "‚Ä¢ HR user contact information"
echo "‚Ä¢ Pre-leave checklist with actionable items"
echo "‚Ä¢ Beautiful HTML formatting"
echo "‚Ä¢ Mobile-responsive design"
echo ""
echo "‚ú® Rejection Emails Include:"
echo "‚Ä¢ Empathetic and understanding tone"
echo "‚Ä¢ Clear rejection reason from HR"
echo "‚Ä¢ Alternative suggestions and next steps"
echo "‚Ä¢ HR contact info for direct discussion"
echo "‚Ä¢ Encouragement to reapply with modifications"
echo ""
echo "üîß GMAIL APP PASSWORD SETUP:"
echo "============================"
echo ""
echo "To enable HR direct emails:"
echo "1. Go to: https://myaccount.google.com/security"
echo "2. Enable 2-Factor Authentication"
echo "3. Click '2-Step Verification'"
echo "4. Scroll to 'App passwords'"
echo "5. Generate password for 'Mail'"
echo "6. Use the 16-character password in configuration"
echo ""
echo "üöÄ SYSTEM STATUS:"
echo "================="
echo ""
echo "‚úÖ Dynamic Email System: READY"
echo "‚úÖ HR Direct Communication: AVAILABLE"
echo "‚úÖ AI-Powered Content: ACTIVE"
echo "‚úÖ System Fallback: WORKING"
echo "‚úÖ Professional Templates: LOADED"
echo ""
echo "üéâ Your dynamic email system is ready for testing!"
echo "‚ÑπÔ∏è  The system automatically chooses the best available email method"
echo ""
echo "üîó Useful URLs:"
echo "‚Ä¢ LeaveEase Application: http://localhost:8080"
echo "‚Ä¢ HR Direct Approval: http://localhost:8080/leaves/{id}/hr-approve"
echo "‚Ä¢ HR Direct Rejection: http://localhost:8080/leaves/{id}/hr-reject"
echo "‚Ä¢ HR Email Config: http://localhost:8080/leaves/hr-email-config"
echo ""
echo "‚úÖ Ready to test HR-to-Employee direct email communication!"